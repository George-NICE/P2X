<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球新能源制绿氢耦合化工项目-交互式可视化报告</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Chart.js for Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- mammoth.js for DOCX parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>

    <!-- Custom Font and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .leaflet-popup-content {
            margin: 13px 20px 13px 15px;
            font-size: 14px;
            line-height: 1.6;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #details-panel h4 { font-size: 1.1rem; padding-bottom: 0.5rem; margin-bottom: 0.75rem; border-bottom-width: 2px; }
        #details-panel .detail-item { padding: 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s ease-in-out; }
        #details-panel .detail-item:hover { background-color: #f1f5f9; }

        .file-upload-btn {
            background-color: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s;
        }
        .file-upload-btn:hover { background-color: #4338ca; }
        .update-btn {
            background-color: #16a34a; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s;
        }
        .update-btn:hover { background-color: #15803d; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-md z-20 sticky top-0">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <h1 class="text-xl sm:text-2xl font-bold text-slate-900">全球绿氢化工项目交互式仪表盘</h1>
                    <div class="flex items-center space-x-3">
                        <input type="file" id="file-uploader" class="hidden" accept=".docx">
                        <label for="file-uploader" class="file-upload-btn text-sm font-medium">选择新报告 (.docx)</label>
                        <button id="update-dashboard-btn" class="update-btn text-sm font-medium">更新仪表盘</button>
                        <span id="upload-status" class="text-sm text-slate-500"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column: Filters and Charts -->
                <div class="lg:col-span-1 flex flex-col space-y-6">
                    <!-- Filters -->
                    <div class="bg-white p-5 rounded-xl shadow-md">
                        <h2 class="text-lg font-semibold mb-4 text-slate-700">项目筛选器</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="country-filter" class="block text-sm font-medium text-slate-600 mb-1">所在国家</label>
                                <select id="country-filter" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                            </div>
                            <div>
                                <label for="status-filter" class="block text-sm font-medium text-slate-600 mb-1">项目状态</label>
                                <select id="status-filter" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                            </div>
                            <div>
                                <label for="grid-filter" class="block text-sm font-medium text-slate-600 mb-1">并网方式</label>
                                <select id="grid-filter" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                            </div>
                        </div>
                    </div>
                    <!-- Charts -->
                    <div class="bg-white p-5 rounded-xl shadow-md">
                        <h2 class="text-lg font-semibold mb-4 text-slate-700">数据洞察</h2>
                        <div class="space-y-6">
                            <div><h3 class="text-md font-medium text-center text-slate-600 mb-2">各国绿氢产能 (万吨/年)</h3><canvas id="capacityChart"></canvas></div>
                            <div><h3 class="text-md font-medium text-center text-slate-600 mb-2">各国项目总投资 (亿元人民币)</h3><canvas id="investmentChart"></canvas></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><h3 class="text-md font-medium text-center text-slate-600 mb-2">项目状态分布</h3><canvas id="statusChart"></canvas></div>
                                <div><h3 class="text-md font-medium text-center text-slate-600 mb-2">并网方式分布</h3><canvas id="gridChart"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Map and Details -->
                <div class="lg:col-span-2 flex flex-col space-y-6">
                    <div class="bg-white rounded-xl shadow-md h-[400px] lg:h-[500px] flex flex-col"><div id="map" class="w-full h-full rounded-xl"></div></div>
                    <div id="details-panel" class="bg-white p-6 rounded-xl shadow-md min-h-[400px]">
                        <div id="details-content" class="h-full custom-scrollbar overflow-y-auto pr-3">
                           <div class="flex flex-col justify-center items-center h-full text-slate-400">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-20 h-20 mb-4"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                               <p class="text-lg font-medium">请在地图上点击一个项目标记</p>
                               <p class="text-sm">以查看详细信息</p>
                           </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DATA SOURCE (Updated from "全球电氢化耦合项目分析报告0609.docx") ---
        let projects = [
            {
                name: "中石化新疆库车绿氢示范项目",
                owner: "中国石化",
                country: "中国",
                location: { lat: 41.71, lon: 82.93 },
                grid: "强连接并网型 (部分并网)",
                status: "运营",
                operationDate: "2023-06-30",
                renewableCapacity: "260MW电解槽，配套光伏",
                h2Capacity: 2.0,
                product: "炼化用氢",
                productCapacity: null,
                investment: null,
                bottlenecks: "绿氢成本高；新能源波动性导致设备利用率偏低；产业链配套不成熟。",
                issues: "已安全平稳运行超过335天，但面临成本和波动性挑战。",
                lessons: "实现了规模化光伏发电直接制绿氢，产储输用一体化。为行业积累了宝贵的FOAK（首创性）经验。",
                description: "位于新疆阿克苏，是国内首个万吨级光伏制氢炼化项目。项目采用光伏发电直接制氢（52台碱性电解槽），绿氢通过管道输送至塔河炼化公司。配套21万标立方储氢设施。光伏电站部分电力上网，部分用于制氢。中石化官方指出，该项目揭示了绿氢成本、新能源波动性和产业链配套等核心挑战，但其成功运行证明了技术路线的可行性。"
            },
            {
                name: "三峡纳日松光伏制氢生产绿氨项目",
                owner: "三峡集团",
                country: "中国",
                location: { lat: 39.82, lon: 110.05 },
                grid: "强连接并网型",
                status: "运营",
                operationDate: "2023-12-29 (光伏并网)",
                renewableCapacity: "40万千瓦光伏，75MW电解槽",
                h2Capacity: 1.0,
                product: "绿氨 (规划)",
                productCapacity: null,
                investment: 28.3,
                bottlenecks: "商业化与规模化经验积累。",
                issues: "项目主要目标为积累氢能领域经验。",
                lessons: "作为三峡集团首个光伏制氢项目，为公司培养了氢能人才，积累了宝贵经验。",
                description: "位于内蒙古鄂尔多斯，是三峡集团首个光伏制氢项目。光伏电站已全面并网发电，年产氢约1万吨，副产氧气约8万吨。下游规划生产绿氨。该项目重在为集团积累氢能产业经验。"
            },
            {
                name: "大唐多伦15万千瓦风光制氢一体化示范项目",
                owner: "大唐集团",
                country: "中国",
                location: { lat: 42.18, lon: 116.46 },
                grid: "离网或半离网型",
                status: "运营", // Updated from '在建' based on "2025年1月17日正式并网投产"
                operationDate: "2025-01-17",
                renewableCapacity: "15万千瓦风光",
                h2Capacity: 0.63,
                product: "耦合煤化工用氢，天然气掺氢",
                productCapacity: null,
                investment: 13, 
                bottlenecks: "离网系统稳定性；与煤化工的深度耦合技术；天然气掺氢技术验证。",
                issues: "已并网投产，具体运行数据待观察。",
                lessons: "旨在探索绿电、绿氢、绿色煤化工“三位一体”发展新模式，是国内首个中大型风光离网制氢深度耦合煤化工的科技示范项目。",
                description: "位于内蒙古多伦，是国内首个中大型风光离网制氢深度耦合煤化工的科技示范项目。项目不依赖电网调峰和消纳，完全离网运行。除了耦合煤化工，还探索管道储氢、天然气掺氢等技术，具有很强的技术示范意义。"
            },
             {
                name: "深能鄂托克旗风光制氢一体化合成绿氨项目",
                owner: "深圳能源",
                country: "中国",
                location: { lat: 39.10, lon: 107.98 },
                grid: "弱连接并网型",
                status: "在建",
                operationDate: "2024-11-28主体开工",
                renewableCapacity: "500MW风电场，5MW离网光伏",
                h2Capacity: 2.0,
                product: "绿氨",
                productCapacity: "15",
                investment: 38.8,
                bottlenecks: "大规模风电制氢的稳定性；绿氨合成效率。",
                issues: "项目初期因弃土外运及审批延误，工期面临风险。",
                lessons: "典型的“新能源发电+绿氢+绿氨”一体化项目，风电并网，80%电力用于制氢。",
                description: "位于内蒙古鄂尔多斯，总投资38.8亿元。项目核心是利用500MW风电场发电制氢，再与空分氮气合成15万吨绿氨。风电并网但大部分电力（80%）用于制氢，体现了弱连接的并网模式。"
            },
            {
                name: "国电投大安风光制绿氢合成氨一体化示范项目",
                owner: "国家电投",
                country: "中国",
                location: { lat: 45.50, lon: 124.28 },
                grid: "弱连接并网型 (源网荷储一体化)",
                status: "在建",
                operationDate: "2023-05开工，已进入调试",
                renewableCapacity: "800MW (700MW风, 100MW光)",
                h2Capacity: 3.2,
                product: "绿氨",
                productCapacity: "18",
                investment: 59.56,
                bottlenecks: "源网荷储一体化系统的优化与控制。",
                issues: "建设中，暂无运行数据。",
                lessons: "采用混合电解槽（PEM+碱性）兼顾效率与经济性。采用“绿氢消纳绿电、绿氨消纳绿氢”的理念，其“源网荷储一体化”全产业链设计是重要创新点。",
                description: "位于吉林白城，被称为全球最大的绿氢合成氨项目。其核心理念是“源网荷储一体化”，通过全产业链的耦合设计，实现绿电的就地消纳和绿氢的高效转化，是探索新能源与现代化工深度融合的标杆项目。"
            },
            {
                name: "中能建松原绿色氢氨醇一体化项目",
                owner: "中国能建",
                country: "中国",
                location: { lat: 45.14, lon: 124.82 },
                grid: "弱连接并网型",
                status: "在建",
                operationDate: "2023-10开工",
                renewableCapacity: "配套300万千瓦新能源",
                h2Capacity: 11.0,
                product: "绿氨/绿醇",
                productCapacity: "60 (氨)/6 (醇)", // 60万吨氨，6万吨甲醇
                investment: 296,
                bottlenecks: "多项全球领先技术的大规模集成；柔性合成氨/甲醇技术的可靠性。",
                issues: "建设初期，暂无运行数据。",
                lessons: "项目攻克了新能源波动性与化工生产稳定性的行业难题，让化工负荷随新能源电力“动态起舞”。",
                description: "位于吉林松原，总投资巨大，是一个全产业链综合项目。涵盖制氢、储运、加氢、氢化工、氢装备等环节。技术上采用多稳态柔性合成氨、CO2+H2制绿色甲醇等前沿技术，致力于实现新能源与化工负荷的动态匹配。"
            },
            {
                name: "远景赤峰翁牛特旗绿色氢氨项目",
                owner: "远景能源",
                country: "中国",
                location: { lat: 43.3, lon: 119.0 },
                grid: "弱连接并网型",
                status: "在建",
                operationDate: "元宝山项目预计2024-06开工",
                renewableCapacity: "风光储一体化",
                h2Capacity: 11.0,
                product: "绿氨，绿甲醇",
                productCapacity: "48 (氨), 12 (甲醇)",
                investment: 266, // 元宝山项目
                bottlenecks: "超大规模风光储氢氨醇系统的优化与成本控制。",
                issues: "建设初期，暂无运行数据。",
                lessons: "远景能源宣称其为全球最大、成本最低的绿氢氨项目，核心是通过源荷互动和储能优化来降低成本，探索零碳产业园模式。",
                description: "位于内蒙古赤峰，是远景能源打造的零碳产业园的核心部分。项目强调通过风光储一体化和智能物联网技术，实现源荷之间的最优互动，从而以最低成本生产绿氢、绿氨和绿甲醇，是市场化驱动的典型代表。"
            },
            {
                name: "国华投资沧州10万吨/年绿氢制合成氨项目",
                owner: "国华投资",
                country: "中国",
                location: { lat: 38.3, lon: 117.4 },
                grid: "强连接并网型",
                status: "在建",
                operationDate: "新能源部分2024-03开工",
                renewableCapacity: "百万千瓦级新能源大基地",
                h2Capacity: 1.95, 
                product: "绿氨，燃料电池级氢气",
                productCapacity: "10 (氨)",
                investment: 60, 
                bottlenecks: "多稳态柔性合成氨技术的大规模应用；电解槽低成本长寿命运行。",
                issues: "建设初期，暂无运行数据。",
                lessons: "通过自主可控的DCS&SIS系统与数字化平台，围绕绿氢“制、储、输、用”全链条持续完善技术能力，实现“风光氢氨”全流程智能协同。",
                description: "位于河北沧州，分两期建设。采用13台1000Nm³/h碱性电解槽（中车株洲所中标），并采用多稳态柔性合成氨工艺。项目致力于打造沿海地区的绿氨综合应用示范，探索风光氢氨一体化模式。"
            },
             {
                name: "中煤平朔60万千瓦离网式可再生能源制氢项目",
                owner: "中煤平朔",
                country: "中国",
                location: { lat: 39.54, lon: 112.44 },
                grid: "离网或半离网型",
                status: "在建",
                operationDate: "计划2025-05开工",
                renewableCapacity: "一期10万千瓦离网光伏",
                h2Capacity: 0.2785,
                product: "耦合煤化工用氢",
                productCapacity: null,
                investment: 4.28,
                bottlenecks: "离网系统长期可靠性；与煤化工的柔性耦合难度。",
                issues: "建设初期，暂无运行数据。",
                lessons: "利用采煤沉陷区土地资源建设离网光伏制氢，实现新能源就地消纳并与现有煤化工耦合，是资源综合利用的典范。",
                description: "位于山西朔州平鲁煤矿沉陷区，充分利用了采煤区的土地资源。项目采用离网光伏制氢，柔性耦合现有煤化工项目，是探索传统能源企业转型、实现新能源与煤化工协同发展的典型案例。"
            },
            {
                name: "国能榆林煤化工与新能源耦合示范项目",
                owner: "国能榆林化工",
                country: "中国",
                location: { lat: 38.28, lon: 109.73 },
                grid: "离网或半离网型",
                status: "运营",
                operationDate: "2024-10 (离网调试成功)",
                renewableCapacity: "光伏 (离网)",
                h2Capacity: 0.032, //年产量36万Nm³
                product: "耦合煤化工用氢",
                productCapacity: null,
                investment: 1.3,
                bottlenecks: "高温储热技术应用；离网系统控制；煤化工耦合效率。",
                issues: "调试运行中，曾攻克储热模块保压、制氢电源偏温等技术难题。",
                lessons: "成功实现了离网运行，并填补了国内高温储热领域技术空白，为风光氢储一体化方案提供了宝贵经验。",
                description: "位于陕西榆林，于2024年10月成功实现光伏“离网”制氢调试。项目在攻克储热模块制高压蒸汽、制氢电源稳定等技术难题方面取得了突破，为国内离网制氢耦合化工积累了宝贵的FOAK经验。"
            },
            {
                name: "沙特NEOM绿氢合成氨项目",
                owner: "NEOM, Air Products, ACWA Power",
                country: "沙特",
                location: { lat: 28.37, lon: 35.15 },
                grid: "离网或半离网型",
                status: "在建",
                operationDate: "计划2026年底投产",
                renewableCapacity: "约4GW (太阳能和风能)",
                h2Capacity: 21.9,
                product: "绿氨 (出口)",
                productCapacity: "120",
                investment: 604.8, 
                bottlenecks: "超大规模可再生能源集成；绿氨储运成本与安全；国际市场波动。",
                issues: "截至2025年6月，项目建设完成度80%。",
                lessons: "全球规模最大的绿氢项目之一，采用100%可再生能源，以绿氨形式出口氢能，并签订了30年绿氨承购协议，为大型项目融资和市场开拓提供了范本。",
                description: "位于沙特NEOM新城，是全球旗舰级的绿氢项目。利用约4GW的陆上风光电力，通过2GW德国蒂森克虏伯的碱性电解槽制氢，再合成120万吨/年绿氨用于出口。项目获得了23家银行和金融机构的复杂融资，并由Air Products签订了30年独家承购协议，是商业模式创新的典范。"
            },
            {
                name: "壳牌REFHYNE及REFHYNE II项目",
                owner: "壳牌等",
                country: "德国",
                location: { lat: 50.82, lon: 6.97 },
                grid: "强连接并网型",
                status: "运营/在建",
                operationDate: "I期:2021-07, II期:预计2027",
                renewableCapacity: "可再生电力",
                h2Capacity: 1.73, // I期: 0.13, II期: 1.6
                product: "炼油厂用氢",
                productCapacity: null,
                investment: null,
                bottlenecks: "FOAK工程挑战；与炼厂系统集成复杂；电力采购经济性与法规不确定性。",
                issues: "I期：报警过多；DCS集成困难；电力成本高昂，导致电解槽利用率低。",
                lessons: "揭示了FOAK项目的普遍挑战，包括管理模式、技术集成、政策波动等。强调了“一个项目，一个团队”合作模式和早期承包商介入的重要性。",
                description: "位于德国莱茵兰壳牌能源与化工园区。I期(10MW PEM)已投运，是欧洲首个工业级PEM应用，探索了参与电网平衡服务。II期计划扩建至100MW。该项目为行业提供了宝贵的FOAK经验，尤其是在技术集成、项目管理和应对政策市场变化方面。"
            },
            {
                name: "挪威YARA Porsgrunn绿氨项目 (HEGRA)",
                owner: "Yara",
                country: "挪威",
                location: { lat: 59.14, lon: 9.65 },
                grid: "强连接并网型",
                status: "在建",
                operationDate: "24MW示范项目预计2023产出",
                renewableCapacity: "可再生电力 (挪威以水电为主)",
                h2Capacity: 0.365,
                product: "绿氨, 绿色化肥",
                productCapacity: "目标40",
                investment: 2.2, 
                bottlenecks: "现有氨厂改造的兼容性；绿氢成本；大规模电解槽稳定运行。",
                issues: "示范项目运行数据未详细披露。",
                lessons: "利用现有大型氨厂进行改造，可快速实现大规模绿氨入市，并利用现有基础设施和运输网络。成立独立清洁氨业务单元，专注新市场开发。",
                description: "位于挪威Porsgrunn，通过对现有氨厂进行电气化改造生产绿氨。初期建设24MW PEM电解槽示范。Yara利用其在氨生产和全球贸易物流的领先地位，成立Yara Clean Ammonia独立业务单元，专注于开发船用燃料、发电等清洁氨新市场。"
            },
            {
                name: "巴斯夫Hy4CHem项目",
                owner: "巴斯夫等",
                country: "德国",
                location: { lat: 49.48, lon: 8.44 },
                grid: "强连接并网型",
                status: "运营",
                operationDate: "2025-03-17",
                renewableCapacity: "可再生电力",
                h2Capacity: 0.8,
                product: "多种化工产品原料，氢燃料交通",
                productCapacity: null,
                investment: 11.7, 
                bottlenecks: "绿氢成本高企（依赖补贴）；足量且经济的绿电供应；氢气基础设施建设。",
                issues: "刚投运，无长期运行数据。",
                lessons: "实现了PEM技术首次直接集成到大型化工Verbund生产环境；利用现有管网避免了重建供应链的高昂成本；是公私合营融资模式的成功案例。",
                description: "位于德国路德维希港巴斯夫Verbund基地，是全球首次将54MW PEM电解技术直接集成到大型化工生产环境中。绿氢并入基地氢气管网，用于生产多种化工产品和供应交通。项目采用ISCC+认证的质量平衡法，并依赖政府资金支持，凸显了当前绿氢生产的经济性挑战。"
            }
        ];

        // --- GLOBAL VARIABLES & STATE ---
        let map;
        let capacityChart, investmentChart, statusChart, gridChart;
        let markers = [];

        // --- UTILITY FUNCTIONS ---
        const getUniqueValues = (key) => [...new Set(projects.map(p => p[key]).filter(Boolean))].sort();
        const formatValue = (value, unit = '') => (value !== null && value !== undefined && value !== "(未明确)") ? `${value} ${unit}`.trim() : '<span class="text-slate-400">未提供</span>';

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            populateFilters();
            initializeCharts();
            updateDashboard();

            document.getElementById('country-filter').addEventListener('change', updateDashboard);
            document.getElementById('status-filter').addEventListener('change', updateDashboard);
            document.getElementById('grid-filter').addEventListener('change', updateDashboard);
            document.getElementById('update-dashboard-btn').addEventListener('click', handleFileUpload);
        });

        // --- MAP INITIALIZATION ---
        function initializeMap() {
            map = L.map('map').setView([30, 50], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 14,
                minZoom: 2
            }).addTo(map);
        }

        // --- FILTERS INITIALIZATION ---
        function populateFilters() {
            const countryFilter = document.getElementById('country-filter');
            const statusFilter = document.getElementById('status-filter');
            const gridFilter = document.getElementById('grid-filter');
            
            countryFilter.innerHTML = '<option value="all">所有国家</option>';
            statusFilter.innerHTML = '<option value="all">所有状态</option>';
            gridFilter.innerHTML = '<option value="all">所有方式</option>';

            getUniqueValues('country').forEach(val => countryFilter.add(new Option(val, val)));
            getUniqueValues('status').forEach(val => statusFilter.add(new Option(val, val)));
            getUniqueValues('grid').forEach(val => gridFilter.add(new Option(val, val)));
        }
        
        // --- CHARTS INITIALIZATION ---
        function initializeCharts() {
            Chart.defaults.font.family = "'Inter', 'Noto Sans SC', sans-serif";
            const pieChartOptions = {
                 responsive: true,
                 maintainAspectRatio: true,
                 plugins: { legend: { position: 'bottom', labels: { font: { size: 11 }, boxWidth: 12, padding: 15 }}}
            };
            const barChartOptions = (isY=false) => ({
                responsive: true,
                indexAxis: isY ? 'y' : 'x',
                scales: { x: { ticks: { font: { size: 10 } } }, y: { ticks: { font: { size: 10 } } } },
                plugins: { legend: { display: false } },
            });
            capacityChart = new Chart(document.getElementById('capacityChart'), { type: 'bar', data: {}, options: barChartOptions(true) });
            investmentChart = new Chart(document.getElementById('investmentChart'), { type: 'bar', data: {}, options: barChartOptions(true) });
            statusChart = new Chart(document.getElementById('statusChart'), { type: 'doughnut', data: {}, options: pieChartOptions });
            gridChart = new Chart(document.getElementById('gridChart'), { type: 'doughnut', data: {}, options: pieChartOptions });
        }
        
        // --- DASHBOARD UPDATE LOGIC ---
        function updateDashboard() {
            const country = document.getElementById('country-filter').value;
            const status = document.getElementById('status-filter').value;
            const grid = document.getElementById('grid-filter').value;

            const filteredProjects = projects.filter(p => 
                (country === 'all' || p.country === country) &&
                (status === 'all' || p.status === status) &&
                (grid === 'all' || p.grid === grid)
            );

            updateMap(filteredProjects);
            updateCharts(filteredProjects);
            if (filteredProjects.length === 1) {
                updateDetailsPanel(filteredProjects[0]);
            } else {
                 const detailsContent = document.getElementById('details-content');
                 detailsContent.innerHTML = `<div class="flex flex-col justify-center items-center h-full text-slate-400">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-20 h-20 mb-4"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                               <p class="text-lg font-medium">请在地图上点击一个项目标记</p>
                               <p class="text-sm">以查看详细信息</p>
                           </div>`;
            }
        }

        // --- MAP UPDATE ---
        function updateMap(filteredProjects) {
            markers.forEach(marker => marker.remove());
            markers = [];
            if (filteredProjects.length === 0) return;

            filteredProjects.forEach(project => {
                const statusColors = { '运营': '#22c55e', '在建': '#f59e0b', '试运行': '#3b82f6', '运营/在建': '#a855f7'};
                const color = statusColors[project.status] || '#64748b';
                
                const marker = L.circleMarker([project.location.lat, project.location.lon], {
                    radius: 6 + Math.sqrt(project.h2Capacity || 1) * 2,
                    fillColor: color, color: '#fff', weight: 1.5, opacity: 1, fillOpacity: 0.8
                }).addTo(map);

                marker.bindPopup(`
                    <div class="font-sans">
                        <h3 class="font-bold text-base mb-1 text-slate-800">${project.name}</h3>
                        <p><strong>状态:</strong> <span class="font-semibold" style="color:${color};">${project.status}</span></p>
                        <p><strong>氢气产能:</strong> ${project.h2Capacity || 'N/A'} 万吨/年</p>
                    </div>
                `);
                marker.on('click', () => updateDetailsPanel(project));
                markers.push(marker);
            });
            
            if (markers.length > 0) {
                 const group = new L.featureGroup(markers);
                 map.fitBounds(group.getBounds().pad(0.3));
            }
        }

        // --- CHARTS UPDATE ---
        function updateCharts(filteredProjects) {
            const backgroundColors = ['#3b82f6', '#16a34a', '#f97316', '#ef4444', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#64748b'];
            const capacityByCountry = {}, investmentByCountry = {};
            filteredProjects.forEach(p => {
                if(p.h2Capacity) { capacityByCountry[p.country] = (capacityByCountry[p.country] || 0) + p.h2Capacity; }
                if(p.investment) { investmentByCountry[p.country] = (investmentByCountry[p.country] || 0) + p.investment; }
            });

            const sortedCapacity = Object.entries(capacityByCountry).sort(([,a],[,b]) => a-b);
            const sortedInvestment = Object.entries(investmentByCountry).sort(([,a],[,b]) => a-b);

            capacityChart.data = { labels: sortedCapacity.map(item => item[0]), datasets: [{ data: sortedCapacity.map(item => item[1].toFixed(2)), backgroundColor: backgroundColors }] };
            investmentChart.data = { labels: sortedInvestment.map(item => item[0]), datasets: [{ data: sortedInvestment.map(item => item[1].toFixed(2)), backgroundColor: backgroundColors.slice().reverse() }] };

            const statusCounts = {}, gridCounts = {};
            filteredProjects.forEach(p => {
                statusCounts[p.status] = (statusCounts[p.status] || 0) + 1;
                gridCounts[p.grid] = (gridCounts[p.grid] || 0) + 1;
            });
            const pieColors = { '运营': '#22c55e', '在建': '#f59e0b', '试运行': '#3b82f6', '运营/在建': '#a855f7' };
            Object.assign(pieColors, { '强连接并网型': '#6366f1', '弱连接并网型': '#a855f7', '离网或半离网型': '#ec4899', '强连接并网型 (部分并网)': '#6366f1', '弱连接并网型 (源网荷储一体化)': '#a855f7'});

            statusChart.data = { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: Object.keys(statusCounts).map(k => pieColors[k] || '#94a3b8') }] };
            gridChart.data = { labels: Object.keys(gridCounts), datasets: [{ data: Object.values(gridCounts), backgroundColor: Object.keys(gridCounts).map(k => pieColors[k] || '#94a3b8') }] };

            [capacityChart, investmentChart, statusChart, gridChart].forEach(c => c.update());
        }

        // --- DETAILS PANEL UPDATE ---
        function updateDetailsPanel(project) {
            const detailsContent = document.getElementById('details-content');
            const statusColors = { '运营': '#16a34a', '在建': '#d97706', '试运行': '#2563eb', '运营/在建': '#9333ea' };
            const statusColor = statusColors[project.status] || '#475569';

            detailsContent.innerHTML = `
                <div>
                    <h3 class="text-2xl font-bold text-slate-900 mb-4 pb-2 border-b">${project.name}</h3>
                    <div class="bg-indigo-50 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold text-lg text-indigo-800 mb-2">报告摘要</h4>
                        <p class="text-slate-700 text-sm leading-relaxed">${project.description || '暂无详细描述信息。'}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm mb-6">
                        <div class="flex items-start detail-item"><strong class="w-28 shrink-0 text-slate-500">所有者/业主:</strong> <span class="font-medium">${formatValue(project.owner)}</span></div>
                        <div class="flex items-start detail-item"><strong class="w-28 shrink-0 text-slate-500">所在国家:</strong> <span class="font-medium">${project.country}</span></div>
                        <div class="flex items-start detail-item"><strong class="w-28 shrink-0 text-slate-500">项目状态:</strong> <span class="font-semibold py-0.5 px-2 rounded-full text-white" style="background-color:${statusColor}; font-size: 0.75rem;">${project.status}</span></div>
                        <div class="flex items-start detail-item"><strong class="w-28 shrink-0 text-slate-500">并网方式:</strong> <span class="font-medium">${project.grid}</span></div>
                        <div class="flex items-start detail-item"><strong class="w-28 shrink-0 text-slate-500">开车/启动时间:</strong> <span class="font-medium">${formatValue(project.operationDate)}</span></div>
                        <div class="flex items-start detail-item"><strong class="w-28 shrink-0 text-slate-500">可再生能源:</strong> <span class="font-medium">${formatValue(project.renewableCapacity)}</span></div>
                        <div class="flex items-start detail-item"><strong class="w-28 shrink-0 text-slate-500">氢气产能:</strong> <span class="font-medium text-indigo-600">${formatValue(project.h2Capacity, '万吨/年')}</span></div>
                        <div class="flex items-start detail-item"><strong class="w-28 shrink-0 text-slate-500">下游产品:</strong> <span class="font-medium">${formatValue(project.product)}</span></div>
                        <div class="flex items-start detail-item"><strong class="w-28 shrink-0 text-slate-500">产品产能:</strong> <span class="font-medium">${formatValue(project.productCapacity, '万吨/年')}</span></div>
                        <div class="flex items-start detail-item"><strong class="w-28 shrink-0 text-slate-500">总投资:</strong> <span class="font-medium text-indigo-600">${formatValue(project.investment, '亿元人民币')}</span></div>
                    </div>
                    <div class="space-y-5">
                        <div><h4 class="font-semibold text-slate-700 border-indigo-300">核心技术瓶颈</h4><p class="text-slate-600 text-sm leading-relaxed mt-1">${project.bottlenecks || '暂无信息'}</p></div>
                        <div><h4 class="font-semibold text-slate-700 border-amber-400">运营问题/挑战</h4><p class="text-slate-600 text-sm leading-relaxed mt-1">${project.issues || '暂无信息'}</p></div>
                        <div><h4 class="font-semibold text-slate-700 border-emerald-400">经验与教训</h4><p class="text-slate-600 text-sm leading-relaxed mt-1">${project.lessons || '暂无信息'}</p></div>
                    </div>
                </div>
            `;
        }
        
        // --- FILE UPLOAD AND PARSING LOGIC ---
        function handleFileUpload() {
            const uploader = document.getElementById('file-uploader');
            const statusSpan = document.getElementById('upload-status');
            
            if (uploader.files.length === 0) {
                statusSpan.textContent = '请先选择一个文件。';
                statusSpan.style.color = 'red';
                return;
            }

            const file = uploader.files[0];
            statusSpan.textContent = '正在读取文件...';
            statusSpan.style.color = 'orange';

            const reader = new FileReader();
            reader.onload = function(event) {
                // Use convertToHtml for robust table parsing
                mammoth.convertToHtml({ arrayBuffer: event.target.result })
                    .then(result => {
                        statusSpan.textContent = '文件读取成功，正在解析...';
                        const newProjects = parseHtmlData(result.value);
                        if (newProjects.length > 0) {
                            projects = newProjects; 
                            populateFilters(); 
                            updateDashboard(); 
                            statusSpan.textContent = `更新成功！加载了 ${projects.length} 个项目。`;
                            statusSpan.style.color = 'green';
                        } else {
                            throw new Error("未能在文件中解析出有效项目数据。请检查文件格式。");
                        }
                    })
                    .catch(err => {
                        console.error("Error processing file:", err);
                        statusSpan.textContent = `文件处理失败: ${err.message}`;
                        statusSpan.style.color = 'red';
                    });
            };
            reader.onerror = function() {
                statusSpan.textContent = '读取文件失败！';
                statusSpan.style.color = 'red';
            };
            reader.readAsArrayBuffer(file);
        }
        
        // New parsing function using HTML structure
        function parseHtmlData(htmlString) {
            const newProjects = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlString;
            const allTables = tempDiv.querySelectorAll('table');
            let projectTable = null;
        
            // Heuristically find the project table by checking its header content
            for (const table of allTables) {
                const firstRow = table.querySelector('tr');
                if (firstRow) {
                    const headerText = firstRow.textContent.toLowerCase();
                    if (headerText.includes('项目名称') && headerText.includes('国别') && headerText.includes('并网方式')) {
                        projectTable = table;
                        break;
                    }
                }
            }

            if (!projectTable) {
                console.warn("Could not find a valid project data table in the document.");
                alert("解析失败: 未能在Word文档中找到包含'项目名称'和'国别'的有效数据表。请检查文档结构。");
                return [];
            }
        
            const dataRows = projectTable.querySelectorAll('tr');
            // Start from 1 to skip header row
            for (let i = 1; i < dataRows.length; i++) {
                const cells = dataRows[i].querySelectorAll('td');
                if (cells.length >= 13) {
                    try {
                        const name = cells[0].textContent.trim();
                        if (!name) continue; // Skip empty rows

                        // Merge with existing data to preserve location/description if available
                        const existingProject = projects.find(p => p.name === name) || {};
                        
                        const h2CapRaw = cells[6].textContent.trim();
                        const h2CapMatch = h2CapRaw.match(/[\d\.]+/);
                        
                        const newProject = {
                            name: name,
                            country: cells[1].textContent.trim(),
                            grid: cells[2].textContent.trim(),
                            status: cells[3].textContent.trim(),
                            operationDate: cells[4].textContent.trim(),
                            renewableCapacity: cells[5].textContent.trim(),
                            h2Capacity: h2CapMatch ? parseFloat(h2CapMatch[0]) : null,
                            product: cells[7].textContent.trim(),
                            productCapacity: cells[8].textContent.trim(),
                            investment: parseFloat(cells[9].textContent.trim()) || null,
                            bottlenecks: (cells[10].textContent || '').replace(/\d+\s*$/, '').trim(),
                            issues: (cells[11].textContent || '').replace(/\d+\s*$/, '').trim(),
                            lessons: (cells[12].textContent || '').replace(/\d+\s*$/, '').trim(),
                            location: existingProject.location || { lat: 0, lon: 0 },
                            description: existingProject.description || "从新报告中更新的数据。"
                        };
                        newProjects.push(newProject);
                    } catch (e) {
                        console.warn(`Skipping malformed row: ${cells[0].textContent}`, e);
                    }
                }
            }
            return newProjects;
        }

    </script>
</body>
</html>
